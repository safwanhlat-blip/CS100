#include<iostream>
#include<fstream>
#include<string>
#include<iomanip>
#include<ctime>
#include<cstdio> 

using namespace std;

// --- Data Structures ---
struct Book{
    int id;
    string title;
    string author;
    bool isAvailable;
};
struct Issuance{
    int bookId; // Renamed from Iid for clarity
    string title;
    string memberName;
    string issueDate;
    bool isReturned;
};

// Accelerated Time System

struct SimTime {
    long lastRunTimestamp; // The real-world time_t of the last run
    int currentVirtualDay; // The current accelerated virtual day
};

// 10 real seconds = 1 virtual day.
const int ACCELERATION_FACTOR = 10; 

SimTime loadSimTime() {
    SimTime sim;
    ifstream timeFile("simtime.txt");
    if (!timeFile.is_open()) {
        cout << "[First-time run: Initializing virtual clock to Day 1]" << endl;
        sim.lastRunTimestamp = time(0); 
        sim.currentVirtualDay = 1;     
    } else {
        timeFile >> sim.lastRunTimestamp;
        timeFile >> sim.currentVirtualDay;
        timeFile.close();
    }
    return sim;
}

void saveSimTime(const SimTime& sim) {
    ofstream timeFile("simtime.txt");
    timeFile << sim.lastRunTimestamp << endl;
    timeFile << sim.currentVirtualDay << endl;
    timeFile.close();
}

// Updates the virtual day based on real time passed.
void updateVirtualTime(SimTime& sim) {
    long currentTime = time(0); 
    long realSecondsPassed = currentTime - sim.lastRunTimestamp;

    if (realSecondsPassed > 0) {
        int virtualDaysPassed = realSecondsPassed / ACCELERATION_FACTOR;

        if (virtualDaysPassed > 0) {
            sim.currentVirtualDay += virtualDaysPassed;
            sim.lastRunTimestamp = currentTime; 
            cout << "------------------------------------------------" << endl;
            cout << "[Clock Update: " << virtualDaysPassed << " virtual days have passed.]" << endl;
            cout << "[Welcome to Virtual Day " << sim.currentVirtualDay << "]" << endl;
            cout << "------------------------------------------------" << endl;
        }
    }
}

// String Parsing Functions


void splitBookLine(string parts[4], string line){
    for(int i=0; i<3; i++){
        int commaPos = line.find(',');
        parts[i] = line.substr(0, commaPos);
        line = line.substr(commaPos + 1);
    }
    parts[3] = line;
}


void parseBook(string parts[4], string line, Book &book){
    for(int i=0; i<3; i++){
        int commaPos = line.find(',');
        parts[i] = line.substr(0, commaPos);
        line = line.substr(commaPos + 1);
    }
    parts[3] = line;
    book.id = stoi(parts[0]); 
    book.title = parts[1]; 
    book.author = parts[2]; 
    book.isAvailable = stoi(parts[3]);
}


void splitIssuanceLine(string parts[5], string line){
    for(int i=0; i<4; i++){
        int commaPos = line.find(',');
        parts[i] = line.substr(0, commaPos);
        line = line.substr(commaPos + 1);
    }
    parts[4] = line;
}


void parseIssuance(string parts[5], string line, Issuance &loan){
    for(int i=0; i<4; i++){
        int commaPos = line.find(',');
        parts[i] = line.substr(0, commaPos);
        line = line.substr(commaPos + 1);
    }
    parts[4] = line;
    loan.bookId = stoi(parts[0]); 
    loan.title = parts[1]; 
    loan.memberName = parts[2]; 
    loan.issueDate = parts[3]; 
    loan.isReturned = stoi(parts[4]);
}


string getLoanDueDate(int bookID) {
    ifstream issuanceFile("issuance.txt");
    Issuance loan;
    string parts[5], line;
    string dueDate = "an unknown date"; 

    while (getline(issuanceFile, line)) {
        if (line.empty()) continue;
        parseIssuance(parts, line, loan);

        // Find the active (unreturned) loan for this book
        if (loan.bookId == bookID && loan.isReturned == 0) {
            // "Day " is 4 chars. substr(4) gets the number.
            int issueDay = stoi(loan.issueDate.substr(4));
            int dueDay = issueDay + 14;
            dueDate = "Day " + to_string(dueDay);
            break; 
        }
    }
    issuanceFile.close();
    return dueDate;
}

// Helper function to find a book's ID from its title.
int getBookIDFromTitle(string title) {
    Book book;
    string parts[4], line;
    ifstream bookFile("data.txt");

    while (getline(bookFile, line)) {
        if (line.empty()) continue;
        parseBook(parts, line, book);
        
        if (book.title == title) {
            bookFile.close();
            return book.id; 
        }
    }
    
    bookFile.close();
    return -1; // Sentinel value: not found
}

// Display Functions
void displayBooks(){
    string line, parts[4];
    cout << left 
         << setw(5) << "ID"
         << setw(50) << "Book Name"
         << setw(30) << "Author"
         << setw(10) << "Availibity" << endl;
         
    ifstream bookFile("data.txt");
    
    while(getline(bookFile, line)){
        if (line.empty()) continue; 
        
        splitBookLine(parts, line);
        cout << left
             << setw(5) << parts[0]
             << setw(50) << parts[1]
             << setw(30) << parts[2];
        if(parts[3] == "0")
            cout << setw(10) << "Borrowed";
        else
            cout << setw(10) << "Available";
        cout << endl;
    }
    bookFile.close();
}

void displayHistory(){
    string line, parts[5];
    cout << left 
         << setw(5) << "ID"
         << setw(50) << "Book Name"
         << setw(30) << "Member"
         << setw(15) << "Date"
         << setw(10) << "Returned" << endl;
         
    ifstream issuanceFile("issuance.txt");

    while(getline(issuanceFile, line)){
        if (line.empty()) continue;

        splitIssuanceLine(parts, line);
        cout << left
             << setw(5) << parts[0]
             << setw(50) << parts[1]
             << setw(30) << parts[2]
             << setw(15) << parts[3];
        if(parts[4] == "0")
            cout << setw(10) << "No";
        else
            cout << setw(10) << "Yes";
        cout << endl;
    }
    issuanceFile.close();
}

void checkAvailabilityById(int bookId){
    Book book;
    string parts[4], line;
    ifstream bookFile("data.txt");
    bool found = false;

    while(getline(bookFile, line)){
        if (line.empty()) continue;
        parseBook(parts, line, book);
        
        if(book.id == bookId){
            if(book.isAvailable == 0) {
                string dueDate = getLoanDueDate(book.id);
                cout << endl << book.title << " is currently on loan. It is due on " << dueDate << "." << endl;
            } else {
                cout << endl << book.title << " is available" << endl;
            }
            found = true;
            break;
        }
    }   
    bookFile.close();
    if (!found) {
        cout << endl << "Book with ID " << bookId << " not found." << endl;
    }
}

void checkAvailabilityByTitle(string title){
    Book book;
    string parts[4], line; 
    ifstream bookFile("data.txt");
    bool found = false; 
    
    while(getline(bookFile, line)){
        if (line.empty()) continue; 
        
        parseBook(parts, line, book);
        if(book.title == title){
            if(book.isAvailable == 0) {
                string dueDate = getLoanDueDate(book.id);
                cout << endl << book.title << " is currently on loan. It is due on " << dueDate << "." << endl;
            } else {
                cout << endl << book.title << " is available" << endl;
            }
            found = true; 
            break;      
        }
    } 
    bookFile.close(); 
    if (!found) {
        cout << endl << "Book with title '" << title << "' not found in the catalog." << endl;
    }
}

void checkAvailability(){
    int choice;
    int bookId;
    cout << endl << "Select one of the search options: " << endl
         << "1. Search by Title" << endl
         << "2. Search by Book ID" << endl
         <<"Enter Your Option: ";
    cin >> choice;
    
    if(choice == 1){
        cout << "Enter the title of Book to check: ";
        string title;
        getline(cin >> ws, title);
        checkAvailabilityByTitle(title);
    }
    else if (choice == 2){
        cout << "Enter the ID of Book to check: ";
        cin >> bookId;
        checkAvailabilityById(bookId);
    }
    else{
        cout << "Wrong Option selected.";
    }
}
    


void addNewIssuance(int bookId, string title, string memberName, string date, bool isReturned){
    ofstream issuanceFile;
    string record = to_string(bookId) + "," + title + "," + memberName + "," + date + "," + to_string(isReturned);
    
    issuanceFile.open("issuance.txt", ios::app); 
    issuanceFile << record << endl;
    issuanceFile.close();
}

// This function effectively updates a book's availability status
// using the safe "temp file" method.
void updateBookAvailability(int id, bool newAvailability) {
    ifstream inFile("data.txt");
    ofstream outFile("data_temp.txt");

    if (!inFile.is_open() || !outFile.is_open()) {
        cout << "Error: Could not open database files for update." << endl;
        return;
    }

    string line;
    string parts[4];
    Book book;
    bool found = false;

    while (getline(inFile, line)) {
        if (line.empty()) continue;

        parseBook(parts, line, book);

        if (book.id == id) {
            // This is the line to change. Reconstruct it.
            outFile << book.id << "," << book.title << "," << book.author << "," << newAvailability << endl;
            found = true;
        } else {
            // Not the line, just copy it over.
            outFile << line << endl;
        }
    }
    inFile.close();
    outFile.close();

    remove("data.txt");
    rename("data_temp.txt", "data.txt");

    if (!found) {
        cout << "Warning: Book ID " << id << " not found in data.txt during update." << endl;
        remove("data_temp.txt"); 
    }
}

// This function marks a book as returned in issuance.txt
void updateIssuanceStatus(int bookID) {
    ifstream inFile("issuance.txt");
    ofstream outFile("issuance_temp.txt");

    if (!inFile.is_open() || !outFile.is_open()) {
        cout << "Error: Could not open database files for update." << endl;
        return;
    }

    string line;
    string parts[5];
    Issuance loan;
    bool foundAndUpdated = false;

    while (getline(inFile, line)) {
        if (line.empty()) continue;

        parseIssuance(parts, line, loan);

        // Check if this is the book AND it's not returned
        
        if (loan.bookId == bookID && loan.isReturned == 0 && !foundAndUpdated) {
            // This is the line to change. Reconstruct it.
            outFile << loan.bookId << "," << loan.title << "," << loan.memberName << "," << loan.issueDate << "," << 1 << endl;
            foundAndUpdated = true;
        } else {
            // Not the line, just copy it over.
            outFile << line << endl;
        }
    }
    inFile.close();
    outFile.close();

    remove("issuance.txt");
    rename("issuance_temp.txt", "issuance.txt");

    if (!foundAndUpdated) {
        cout << "Warning: No active loan found for Book ID " << bookID << " in issuance.txt." << endl;
        remove("issuance_temp.txt");
    }
}

void borrow(SimTime& sim) { 
    int bookId; 
    string title; 
    
    cout << endl << "Enter the Title of book to borrow: ";
    getline(cin >> ws, title);

    bookId = getBookIDFromTitle(title); 

    if (bookId == -1) {
        cout << "Error: Book with title '" << title << "' not found in the catalog." << endl;
        return; 
    }

    string memberName, bookParts[4], bookLine;
    Issuance newLoan;
    
    
    ifstream bookFile("data.txt");
    Book bookToBorrow;
    bool foundBook = false;
    
    while(getline(bookFile, bookLine)){
        if (bookLine.empty()) continue;
        parseBook(bookParts, bookLine, bookToBorrow);
        
        if(bookToBorrow.id == bookId){
            foundBook = true;
            break; 
        }
    }
    
    bookFile.close(); 

    if (!foundBook) {
         cout << "Error: Book record not found. Please try again." << endl;
         return;
    }

    if(bookToBorrow.isAvailable == 0) { 
        string dueDate = getLoanDueDate(bookToBorrow.id);
        cout << "Sorry: The book '" << bookToBorrow.title << "' is currently on loan." << endl;
        cout << "It is due on " << dueDate << "." << endl;
    } else {

        cout << "Enter Your Name: ";
        getline(cin >> ws, memberName);

        newLoan.issueDate = "Day " + to_string(sim.currentVirtualDay);
        
        addNewIssuance(bookToBorrow.id, bookToBorrow.title, memberName, newLoan.issueDate, 0);
        updateBookAvailability(bookToBorrow.id, 0); 
        
        cout << "Successfully borrowed: " << bookToBorrow.title << endl;
        cout << "Issued on: " << newLoan.issueDate << ". Please return within 14 days." << endl;
    }
}

void returnBook(SimTime& sim) { 
    int bookId;
    string title;

    cout << "Enter the Title of the book to return: ";
    getline(cin >> ws, title);

    bookId = getBookIDFromTitle(title); 

    if (bookId == -1) {
        cout << "Error: Book with title '" << title << "' not found in the catalog." << endl;
        return;
    }

    bool isBorrowed = false;
    Issuance loan;
    string loanParts[5], loanLine;
    ifstream issuanceFile("issuance.txt");
    
    while(getline(issuanceFile, loanLine)) {
        if (loanLine.empty()) continue;
        parseIssuance(loanParts, loanLine, loan);
        
        if (loan.bookId == bookId && loan.isReturned == 0) {
            isBorrowed = true;
            
            // Overdue Check Logic
            string dateString = loan.issueDate;
            int issueDay = stoi(dateString.substr(4));
            int daysBorrowed = sim.currentVirtualDay - issueDay;
            
            cout << "------------------------------------------------" << endl;
            cout << "Book was issued on: Day " << issueDay << endl;
            cout << "Today is: Day " << sim.currentVirtualDay << endl;
            cout << "Total days borrowed: " << daysBorrowed << endl;

            if (daysBorrowed > 14) {
                cout << "Status: OVERDUE by " << (daysBorrowed - 14) << " days." << endl;
            } else {
                cout << "Status: Returned on time." << endl;
            }
            cout << "------------------------------------------------" << endl;

            break; 
        }
    }
    issuanceFile.close();

    if (isBorrowed) {
        updateBookAvailability(bookId, 1); 
        updateIssuanceStatus(bookId); 
        cout << endl << "Book ID " << bookId << " (" << title << ") has been successfully returned." << endl;
    } else {
        cout << endl << "Error: " << title << " is not currently on loan." << endl;
    }
}

int main(){
    
    SimTime sim = loadSimTime();
    updateVirtualTime(sim);

    cout << "===== OPTIONS =====" << endl;
    int option;
    do{
        cout << "1. Display Catalogue" << endl
             << "2. Book Availability Check" << endl
             << "3. Borrow a Book" << endl
             << "4. Return a Book" << endl
             << "5. Borrowing History" << endl
             << "6. Exit Program" << endl
             << "ENTER YOUR OPTION: ";
        cin >> option;
        cout << "===== * ====== * ======" << endl;
        switch(option){
            case 1: displayBooks(); break;
            case 2: checkAvailability(); break;
            case 3: borrow(sim); break;
            case 4: returnBook(sim); break; 
            case 5: displayHistory(); break;
            case 6: cout << "Bye........"; break;
            default: cout << "Wrong Option selected "; break;
        }
        cout << "\n=========== *** =========== ****** ==========\n";
    } while(option != 6);

    saveSimTime(sim);

    return 0;
}
