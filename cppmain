
#include<iostream>
#include<fstream>
#include<string>
#include<iomanip>
#include<ctime>
using namespace std;

struct Book{
    int id;
    string Title;
    string Author;
    bool Availability;
};
struct Issuance{
    int Iid;
    string Title;
    string Member;
    string Date;
    bool Returned;
};

void seperateB(string s[4], string e){
    for(int i=0; i<3; i++){
        int x = e.find(',');
        s[i]=e.substr(0,x);
        e = e.substr(x+1);
    }
    s[3]= e;
}
void seperateB(string s[4], string e, Book &bb){
    for(int i=0; i<3; i++){
        int x = e.find(',');
        s[i]=e.substr(0,x);
        e = e.substr(x+1);
    }
    s[3]= e;
    bb.id = stoi(s[0]); bb.Title = s[1]; bb.Author = s[2]; bb.Availability = stoi(s[3]);
}
void seperateI(string s[5], string e){
    for(int i=0; i<4; i++){
        int x = e.find(',');
        s[i]=e.substr(0,x);
        e = e.substr(x+1);
    }
    s[4]= e;
}
void seperateI(string s[5], string e, Issuance &ii){
    for(int i=0; i<4; i++){
        int x = e.find(',');
        s[i]=e.substr(0,x);
        e = e.substr(x+1);
    }
    s[4]= e;
ii.Iid = stoi(s[0]); ii.Title = s[1]; ii.Member = s[2]; ii.Date = s[3]; ii.Returned = stoi(s[4]);
}

void displayBooks(){
string ebook, x[4];
cout<<left 
    <<setw(5)<<"ID"
    <<setw(50)<<"Book Name"
    <<setw(30)<<"Author"
    <<setw(10)<<"Availibity"<<endl;
ifstream fin;
fin.open("data.txt");
while(!fin.eof()){
getline(fin,ebook);
seperateB(x,ebook);
cout<<left
    <<setw(5)<<x[0]
    <<setw(50)<<x[1]
    <<setw(30)<<x[2];
    if(x[3]=="0")
    cout<<setw(10)<<"Borrowed";
    else
    cout<<setw(10)<<"Available";
cout<<endl;
    }
fin.close();
}

void displayHistory(){
string ebook, x[5];
cout<<left 
    <<setw(5)<<"ID"
    <<setw(50)<<"Book Name"
    <<setw(30)<<"Member"
    <<setw(15)<<"Date"
    <<setw(10)<<"Returned"<<endl;
ifstream fin;
fin.open("issuance.txt");
while(!fin.eof()){
getline(fin,ebook);
seperateI(x,ebook);
cout<<left
    <<setw(5)<<x[0]
    <<setw(50)<<x[1]
    <<setw(30)<<x[2]
    <<setw(15)<<x[3];
    if(x[4]=="0")
    cout<<setw(10)<<"No";
    else
    cout<<setw(10)<<"Yes";
cout<<endl;
    }
fin.close();
}

void Issu(int x1, string x2, string x3, string x4, bool x5){
ofstream f;

string record = to_string(x1) + "," + x2 + "," + x3 + "," + x4 + "," + to_string(x5);

f.open("issuance.txt", ios::app);
f<<"\n"<<record<<"\n";
f.close();

}

void checkAvai(int sid){
    Book x;
    string parts[4], in;
    ifstream f;
    f.open("data.txt");
    while(!f.eof()){
    getline(f,in);
    seperateB(parts,in,x);
    if(x.id == sid){
        if(x.Availability == 0)
        cout<<endl<<x.Title<<" is Currently not available "<<endl;
        else
        cout<<endl<<x.Title<<" is available"<<endl;
    break;
}
 }   
 f.close();
}
void checkAvai(){
    Book x;
    string parts[4], in, sid;
    getline(cin >> ws,sid);
    ifstream f;
    f.open("data.txt");
    while(!f.eof()){
    getline(f,in);
    seperateB(parts,in,x);
    if(x.Title == sid){
        if(x.Availability == 0)
        cout<<endl<<x.Title<<" is Currently not available "<<endl;
        else
        cout<<endl<<x.Title<<" is available"<<endl;
    break;
}

 } 
 f.close();  
}

void checkAvailability(){
    int x;
    int y;
    cout<<endl<<"Select one of the search options: "<<endl
        <<"1. Search by Title"<<endl
        <<"2. Search by Book ID"<<endl;
    cin>>x;
    if(x == 1){
        
        cout<<"Enter the title of Book to check: ";
        checkAvai();
    }
    else if (x== 2){
        cout<<"Enter the ID of Book to check: ";
        cin>>y;
        checkAvai(y);
    }
    else{
        cout<<"Wrong Option selected.";
    }
}
   
void updateBA(int id){

Book i;
string x[4], x1;

fstream f;
f.open("data.txt", ios::in | ios::out | ios::binary);
    while(!f.eof()){
        int pos =f.tellg();
        cout << pos << endl;
        getline(f,x1);
        seperateB(x,x1, i);
            if(id == i.id){
                
                
                char u = (i.Availability == 0) ? '1' : '0' ;
                f.seekp(pos + x1.length() - 2);
                f.put(u);
                cout<<endl<<"writing............."<<endl;
            break;
            }
        }

}
void updateIR(int id){

int er{0};
string x[5], x1;
Issuance y;
fstream f;
f.open("issuance.txt");
while(!f.eof()){
    int p = f.tellg();
    getline(f, x1);
    seperateI(x, x1, y);
    if((y.Iid == id)&&(y.Returned == 0)){
        f.seekp(p + x1.length() - 2);
        f.write("1",1);
    er++;    
    break;
    }
}
 if(er==0)
        cout<<endl<<"Error Returning Book!\n"
            <<"Please try later"<<endl;
}

void borrow(){
    int uid, er{0};
    string uname, bname, b[4], bi;
    Issuance i;
    cout<<endl<<"Enter Your Name: ";
    getline(cin>>ws, uname);
    cout<<"Enter the ID of book to borrow: ";
    cin>>uid;

    ifstream f;
    f.open("data.txt");
    while(!f.eof()){
    getline(f, bi);
    seperateB(b, bi);
    if(uid == stoi(b[0])){
            er++;
            if(b[3]=="0")
                cout<<"Sorry: The book is currently not available";
            else{
                
                i.Iid = stoi(b[0]); i.Title = b[1]; i.Member = uname; i.Returned = 0; i.Date = "09-11-2025";
                Issu(i.Iid, i.Title, i.Member, i.Date, i.Returned);
                updateBA(i.Iid); 
                cout<<"Please return the book within two weeks (Availability status not updated...)"<<endl;
            }
    break;
    }
    }
    f.close();
    if(er==0)
        cout<<endl<<"Error Issuing Book!\n"
            <<"Please try later"<<endl;
}
void ReturnB(){
    int x,err{0};
    string x1[5], x2;
    Issuance x3;
    cout<<"\nEnter the id of Book: ";
    cin>>x;
    fstream f;
    f.open("issuance.txt");
    while(!f.eof()){
    getline(f, x2);
    seperateI(x1,x2,x3);

    if((x3.Iid == x) && (x3.Returned == 0)){
    updateBA(x);
    updateIR(x);
    cout<<"Successfull !!!"<<endl;
    err++;
    break;
    }
    }
    if(err == 0)
    cout<<endl<<"Error Finding the record. "<<endl;
}

int main(){
// cout<<"===== OPTIONS ====="<<endl;
// int x;
// do{
// cout<<"1. Display Catalogue"<<endl
//     <<"2. Book Availability Check"<<endl
//     <<"3. Borrow a Book"<<endl
//     <<"4. Return a Book"<<endl
//     <<"5. Browsing History"<<endl
//     <<"6. Exit Program"<<endl
//     <<"ENTER YOUR OPTION: ";
//     cin>>x;
// cout<<"===== * ====== * ======"<<endl;
// switch(x){
//     case 1: displayBooks(); break;
//     case 2: checkAvailability(); break;
//     case 3: borrow(); break;
//     case 4: ReturnB(); break;// working on it
//     case 5: displayHistory(); break;
//     case 6: cout<<"Bye........"; break;
//     default: cout<<"Wrong Option selected "; break;
// }
// cout<<"\n=========== *** =========== ****** ==========\n";
// }while(x != 6);

// return 0;

updateBA(105);


}

